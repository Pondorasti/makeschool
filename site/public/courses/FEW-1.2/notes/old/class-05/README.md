# FEW 1.2 - Class 5

## Updating and Refactoring 

There is a lot of code here. You need to start digging in and figuring out how it works. 

After playing the game/using the code the next step is reading the code and making small changes and improvements.

## Objectives 

- Install ESLint
- Use the linter to improve refactor and anaylze code
- Define Scope
  - Local scope
  - Global Scope
  - Function scope
- Use `const`, `let`, and `var` to define variables in a scope
    - Block scope
    - Function Scope
- Identify the scope of variables and functions
  - Define Closure 
  - Identify the scope of variables captured by Closure
- Use template strings

## ESLint to the Rescue!

What's linting? Linting is the process of cleaning up your code. The linter follows a guide. We will use the Airbnb style guide. You can think of this process as updating your code to the standard used by Airbnb. 

1. Install ESLint
  - Fix all linting errors
  - Take notes on any linter suggestions that you can't solve or don't understand. 
  - Instructions: 
    - Navigate the terminal to your directory
    - `npm init -y`
    - `npm install eslint`
    - `eslint --init` answer the questions: 
      - use a popular style guide
      - Airbnb
      - Do you use React: No
      - Format for config file: JavaScript
      - Would you like to install now: Yes
    - Install ESLint extension in the code editor
      - Code > Preferences > Extensions
      - Search: eslint
      - Click: Install 
    - 
    - You may have to close and reopen your project 
  - Why? 
    - Linting catches errors
    - Recommends best practices
2. Modify the game to make it unique and different from the original 
  - Change the names of things
    - Follow the guide
  - Change the events
    - Rewrite the events 

## Linting

The linter will show red underline on everything in your code it sees that is not following the style guide. 

As you work through your code solving linter errors ask youself why the linter is suggesting the changes it is suggesting. 

Many of the changes the linter will suggest have to do with the topics below. 

## Scope 

Scope is a term that determines where a variable or function is accessible in your software. 

Scope can be Global the variable is visible everywhere or local the variable is accessible in a limited area. 

Variables defined **without** one of the keywords `const`, `let`, or `var` is global. 

## Updating Syntax

**Template Strings**

var t = "Hello"+world // var t = `Hello ${world}`;

The code seems to have been written before template strings. Template Strings are really great, they shorten long string concatenations and are easier to read. They can also be broken up on to multiple lines.

- [Template Strings](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals)

**`const`, `let`, and `var`**

The original code was written before `const` and `let` were available. Using `const` and `let` will improve performance, catch errors, and make your intent more clear.

Updating variable declarations will require you to look at each variable and examine its scope and figure out whether the variable should be mutable or immutable.

Remember `const` and `let` are not hoisted! This effects `var OregonH` which appears at the top of each file! This is shared across all files it will need to use the `var` declaration!

- [const, let, and var](https://hackernoon.com/js-var-let-or-const-67e51dbb716f)
- [const](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const)
- [let](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/let)
- [var](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/var)

## Modify the Game 

Along the way, while you update the code you can also make changes to the game. 

### Game Events 

Events are things that happen in the game. These occur on a probability stored in: `EVENT_PROBABILITY`. Events are defined in the file: `Events.js`. The array `OregonH.Event.eventTypes` holds a list of all of the events. Each event is an object with properties named: 

- `type`: String - naming the type of event
- `notification`: String - positive or negative
- `stat`: String - names the state the event will change
- `value`: Number - value applied to stat by the event
- `text`: String - a message generated by the event
- `products`: Array - of objects 
  - `item`: String - the name of the item
  - `qty`: Number - the number of items that can be bought
  - `price`: Number - the price of an item

The `type` property has a string value which is:

- `STAT-CHANGE` - Changes a stat
- `SHOP` - Shows the Shop box
- `ATTACK` - Shows the Attack box

Some events create a change to a named stat on the `Caravan` Object. The actual change happens somewhere in the code where events are processed. 

Not all events have all properties. For example, only the shop event has `products`. Shop events don't have `stat` or `value`. Shop events change stats on `Caravan` but only when you buy something from the shop. 

## Challenges 

- **Challenge 1**: Updated to Template Strings
  1. Read through your code and examine each String. If there is some concatenation involved with the String change it into a template string. For example: 
  
```JavaScript
// Original Source
this.ui.notify('Left ' + droppedGuns + ' guns behind', 'negative');

// Becomes
this.ui.notify(`Left ${droppedGuns} guns behind`, 'negative');
```

- **Challenge 2**: Update `var` to `const` or `let`
  1. Read through each file and examine each variable declaration. Ask yourself if this variable should be a `const`, `let`, or `var`. 

- **Challenge 3**: Format Code
  1. While the code is formatted well it may not use conventions you are familiar with. Along the way format the code the way that you like to read it. 

- **Challenge 4**: Modifying Events
  1. Read the list of events in Events.js
  2. Add a new event to the list. 
    - Copying an existing event and changing the property values is probably the easiest thing to do.  
    - Play the game until you see your new event appear. 
    - Make a new event for each of the three types of events: `STAT-CHANGE`, `SHOP`, `ATTACK`
    - For `SHOP` events modify the products Array.

## Stretch Challenges 

**Stretch Challenge 1**: Use Object Deconstruction

Using object deconstruction and intermediate variables. 
  
- https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment
  
There are a few places in the code where there are long nested properties. These can be easily destructured to make your work easier. 

Consider this block of code.

```JavaScript
//refresh visual caravan stats
OregonH.UI.refreshStats = function() {
  //modify the dom
  document.getElementById('stat-day').innerHTML = Math.ceil(this.caravan.day);
  document.getElementById('stat-distance').innerHTML = Math.floor(this.caravan.distance);
  document.getElementById('stat-crew').innerHTML = this.caravan.crew;
  document.getElementById('stat-oxen').innerHTML = this.caravan.oxen;
  document.getElementById('stat-food').innerHTML = Math.ceil(this.caravan.food);
  document.getElementById('stat-money').innerHTML = this.caravan.money;
  document.getElementById('stat-firepower').innerHTML = this.caravan.firepower;
  document.getElementById('stat-weight').innerHTML = Math.ceil(this.caravan.weight) + '/' + this.caravan.capacity;
 
  //update caravan position
  document.getElementById('caravan').style.left = (380 * this.caravan.distance/OregonH.FINAL_DISTANCE) + 'px';
};
```

These are long lines of code that are hard to parse on a couple levels. First, they are very long so it's hard to absorb. Second, the properties used are nested within objects which adds to the cognitive load. Consider this: 

```JavaScript
//refresh visual caravan stats
OregonH.UI.refreshStats = function() {
  const { day, distance, crew, oxen, food, money, firepower, weight, capacity } = this.caravan;
  const { ceil } = Math;
  //modify the dom
  document.getElementById('stat-day').innerHTML = ceil(day);
  ...
```

Where the value is written to the DOM the code is much more clear. 


This also works with parameters, consider this example: 

```JavaScript
//buy product
OregonH.UI.buyProduct = function(product) {
  //check we can afford it
  if(product.price > OregonH.UI.caravan.money) {
    OregonH.UI.notify('Not enough money', 'negative');
    return false;
  }
 
  OregonH.UI.caravan.money -= product.price;
  OregonH.UI.caravan[product.item] += +product.qty;
  ...
```

In the function above `product` is an object with properties of `item`, `price`, and `qty`. You can break these into variables in place of the `product` parameter. 

```JavaScript
//buy product
OregonH.UI.buyProduct = function({ item, price, qty }) {
  //check we can afford it
  if(price > OregonH.UI.caravan.money) {
    OregonH.UI.notify('Not enough money', 'negative');
    return false;
  }
     
  OregonH.UI.caravan.money -= price;
  OregonH.UI.caravan[item] += +qty;
  ...
```

**Stretch Challenge 2**: Change the whole story! 

Rewrite all of the events to tell a new and different narrative. Currently, the narrative involves traveling 1000 miles. Along the way the following things can happen: 

- Food Intoxication: Causes loss of crew
- Flu Outbreak: Causes loss of crew
- Worm Infestation: Causes loss of food
- Pick Pockets: Causes loss of money
- Oxen Flu Outbreak: Causes loss of oxen
- Find Wild Berries: Causes gain of food
- Find Wild Oxen: Causes gain of oxen
- Shop: Can buy food, oxen, firepower, or crew
  - "You have Found a shop"
  - "Smugglers sell various goods"
- Bandits are attacking you: Can lose crew or gain money

The existing narrative is fairly grim and flat. This could be changed in many ways. I'm sure you have your own ideas! Here are a few things that I thought of: 

- "Space pirates launch a volley of laser blasts": Loss of crew
- "Friendly Unicorns bless the group": Gain food
- "Orc raiders burst from the trees and attack!": Lose crew or gain money
- "Gnomish traders": sell goods

Narrative works best with a theme. Build your theme around a genre. Fantasy, science fiction, contemporary, or historical are good places to start. Consider your favorite fiction as a source of ideas: 

- Game of Thrones
- Star Wars
- Lord of Rings
- Firefly
- Adventure Time

Think of events that might occur and how these would affect the story. With the existing logic an event can do the following: 

- Stat Change: changes the value of a state positive or negative
- Shop: A shop can offer resources for purchase. Consider making shops that offer some things that are not offered by other shops. This could add interest to your narrative. Gnomish Traders may only sell Clockwork minions (oxen). While Elvish Rangers only sell Lembas Bread (food). 

Stats can be worked with to make the game interesting. Here is a list of the stats in play: 

- day
- distance
- crew
- oxen
- food
- money
- firepower

Crew, oxen, food, money, and firepower are obvious choices for gains, losses, and purchases. But, who's to say a "friendly gold dragon" can't carry the group 50 miles (effects distance) or an "evil wizard" can't cast a time travel spell (effects the day).

Changing the name of stats can add a lot to describe and support your narrative. Consider these:

- money: Sounds pretty pedestrian
- gold: Sounds fantasy
- doubloons: Sounds like Pirates
- credits: Sounds Sci-Fi

- crew: Sounds like people
- Pirates: Arr Matey!
- soldiers: Sounds military
- hitpoints: Sounds like you are a single adventurer

- oxen: Sounds like, well, oxen
- fuel: Powers vehicles and spacecraft
- dilithium crystals: Were used to power ships in Star Trek
- engines, thrusters, rockets: These power spacecraft

- firepower: Sounds like guns and stuff
- bullets: Sounds like guns, I like this name better than firepower. 
- swords: Sounds fantasy
- chi: Sounds like a mystical power

- day: Sounds like time in medium scale
- cycles, seasons, years: Sounds like time at a larger scale
- minutes, seconds, microns: Sounds like time on a smaller scale

- distance: In the game is a number that is labeled as miles. This is good and describes things on an earthly scale. Consider tens, hundreds, thousands, or millions of miles. Or if you're trying to add some European style make it metric! 

**Stretch Challenge 3**: Selling Goods

This is more of a stretch challenge. Currently, the shop allows you only to buy items. If you could also sell items that would add a lot of strategies, and give the player more options. It's the options that make games interesting, am I right? 

Solving this challenge will take more work since the game doesn't support this feature currently. To do implement this you'll need to:

- Determine what a shop will buy and how much they will pay. 
- Create an interface that allows sales. Maybe this is just a displaying a list of buttons showing items the player owns and how much the shop will pay for that. But the interface will need to be clear which items are being sold vs which are for sale. 
- You'll need to write a function that handles the transaction. It will need to subtract the item from your stat and add to your money stat. You may also need to check if you have enough of an item to sell it before completing the transaction. 

